/**
 * Custom JSON form editor widget for Contentful.
 * Displays a form generated by a JSON Schema. The form input will generate JSON.
 */

'use strict';

var cfExt = window.contentfulExtension || window.contentfulWidget;

var cfApi = null

var editorElem = createElement('div', {className: 'jfe-editor-root'});
var editor = new JSONEditor(editorElem, {
  theme: 'contentful',
  schema: window.CONTENTFUL_FORM_EDITOR_SCHEMA,
  no_additional_properties: true,
  required_by_default: true,
  disable_collapse: true,
  disable_properties: true,
  show_errors: 'always'
});
editor.on('change', inputChanged);

function inputChanged () {
  cfApi && cfApi.window.updateHeight();
  validateAndSave();
}

var validateAndSave = debounce(function () {
  var errors = editor.validate();

  if (errors.length === 0) {
    save()
  }
}, 150);

var save = function () {
  var currentJSON = editor.getValue()
  if (cfApi) cfApi.field.setValue(currentJSON)
}

function createElement (elem, opts, parent) {
  var e = document.createElement(elem);
  var prop;

  for (prop in opts) {
    e[prop] = opts[prop];
  }
  parent = parent || document.body;
  parent.appendChild(e);
  return e;
}

// http://davidwalsh.name/javascript-debounce-function
function debounce (func, wait) {
  var timeout;
  return function () {
    var context = this, args = arguments;
    var later = function () {
      timeout = null;
      func.apply(context, args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
    if (!timeout) func.apply(context, args);
  };
}

cfExt.init(function (api) {
  cfApi = api
  cfApi.window.startAutoResizer();
  editor.setValue(cfApi.field.getValue())
});
